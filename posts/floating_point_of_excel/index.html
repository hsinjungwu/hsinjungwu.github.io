<!doctype html><html lang=en><head><title>關於 EXCEL 內的浮點數儲存內容 · FR4NK 乾一杯 🍻
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="法蘭克🤪 + 陳馬尼🐶"><meta name=description content="遇到 Issue when importing float as string from Excel. Adding precision incorrectly 跟 Excel importation may misinterpret fractional numbers 提到的問題，細細研究才發現水很深啊～ 😏

  問題重現
  
    
    Link to heading
  


建立一個 Excel 檔案，並在工作表 1 的 A1 儲存格寫上 0.0004
使用 excelize 讀取 A1 的值獲得 4.0000000000000002E-4
接著使用 decimal 解析這個值得到 0.00040000000000000002

然後改用 C# 利用 Microsoft.Office.Interop.Excel 跟 ExcelDataReader 解析出來卻是正確的 0.0004。
原以為是 excelize 的 bug，於透過解壓縮 *.xlsx 的方式找到 \xl\worksheets\sheet1.xml 發現裡面真的是存 4.0000000000000002E-4 😵

  差異原因
  
    
    Link to heading
  

基本上這篇 從 IEEE 754 標準來看為什麼浮點誤差是無法避免的 已經講得蠻清楚的。另外也可以透過這個 Double (IEEE754 Double precision 64-bit) Converter 來得到"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="關於 EXCEL 內的浮點數儲存內容"><meta name=twitter:description content="遇到 Issue when importing float as string from Excel. Adding precision incorrectly 跟 Excel importation may misinterpret fractional numbers 提到的問題，細細研究才發現水很深啊～ 😏
問題重現 Link to heading 建立一個 Excel 檔案，並在工作表 1 的 A1 儲存格寫上 0.0004 使用 excelize 讀取 A1 的值獲得 4.0000000000000002E-4 接著使用 decimal 解析這個值得到 0.00040000000000000002 然後改用 C# 利用 Microsoft.Office.Interop.Excel 跟 ExcelDataReader 解析出來卻是正確的 0.0004。
原以為是 excelize 的 bug，於透過解壓縮 *.xlsx 的方式找到 \xl\worksheets\sheet1.xml 發現裡面真的是存 4.0000000000000002E-4 😵
差異原因 Link to heading 基本上這篇 從 IEEE 754 標準來看為什麼浮點誤差是無法避免的 已經講得蠻清楚的。另外也可以透過這個 Double (IEEE754 Double precision 64-bit) Converter 來得到"><meta property="og:url" content="https://hsinjungwu.github.io/posts/floating_point_of_excel/"><meta property="og:site_name" content="FR4NK 乾一杯 🍻"><meta property="og:title" content="關於 EXCEL 內的浮點數儲存內容"><meta property="og:description" content="遇到 Issue when importing float as string from Excel. Adding precision incorrectly 跟 Excel importation may misinterpret fractional numbers 提到的問題，細細研究才發現水很深啊～ 😏
問題重現 Link to heading 建立一個 Excel 檔案，並在工作表 1 的 A1 儲存格寫上 0.0004 使用 excelize 讀取 A1 的值獲得 4.0000000000000002E-4 接著使用 decimal 解析這個值得到 0.00040000000000000002 然後改用 C# 利用 Microsoft.Office.Interop.Excel 跟 ExcelDataReader 解析出來卻是正確的 0.0004。
原以為是 excelize 的 bug，於透過解壓縮 *.xlsx 的方式找到 \xl\worksheets\sheet1.xml 發現裡面真的是存 4.0000000000000002E-4 😵
差異原因 Link to heading 基本上這篇 從 IEEE 754 標準來看為什麼浮點誤差是無法避免的 已經講得蠻清楚的。另外也可以透過這個 Double (IEEE754 Double precision 64-bit) Converter 來得到"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-06T10:20:00+08:00"><meta property="article:modified_time" content="2021-10-06T10:20:00+08:00"><meta property="article:tag" content="IEEE754"><meta property="article:tag" content="EXCEL"><meta property="article:tag" content="Math"><link rel=canonical href=https://hsinjungwu.github.io/posts/floating_point_of_excel/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/kbd.min.ede294452924ed1c7fe8f864b4a95082f9f30ab56bad8316a0adc2aa57984f45.css integrity="sha256-7eKURSkk7Rx/6PhktKlQgvnzCrVrrYMWoK3CqleYT0U=" crossorigin=anonymous media=screen><link rel=stylesheet href=/table.min.2e07f8da4d6371fee43bd40fd819d2049e79564e705f950772336f415383891a.css integrity="sha256-Lgf42k1jcf7kO9QP2BnSBJ55Vk5wX5UHcjNvQVODiRo=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://hsinjungwu.github.io/>FR4NK 乾一杯 🍻
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/pe/>Project Euler</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://hsinjungwu.github.io/posts/floating_point_of_excel/>關於 EXCEL 內的浮點數儲存內容</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2021-10-06T10:20:00+08:00>2021/10/06
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
One-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/ieee754/>IEEE754</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/excel/>EXCEL</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/math/>Math</a></span></div></div></header><div class=post-content><p>遇到 <a href=https://stackoverflow.com/questions/51025969/issue-when-importing-float-as-string-from-excel-adding-precision-incorrectly class=external-link target=_blank rel=noopener>Issue when importing float as string from Excel. Adding precision incorrectly</a> 跟 <a href=https://community.claris.com/en/s/question/0D50H00006ezK2L/excel-importation-may-misinterpret-fractional-numbers class=external-link target=_blank rel=noopener>Excel importation may misinterpret fractional numbers</a> 提到的問題，細細研究才發現水很深啊～ 😏</p><h2 id=問題重現>問題重現
<a class=heading-link href=#%e5%95%8f%e9%a1%8c%e9%87%8d%e7%8f%be><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ol><li>建立一個 Excel 檔案，並在工作表 1 的 <em>A1</em> 儲存格寫上 <strong>0.0004</strong></li><li>使用 <a href=https://github.com/qax-os/excelize class=external-link target=_blank rel=noopener>excelize</a> 讀取 <em>A1</em> 的值獲得 <strong>4.0000000000000002E-4</strong></li><li>接著使用 <a href=https://github.com/shopspring/decimal class=external-link target=_blank rel=noopener>decimal</a> 解析這個值得到 <strong>0.00040000000000000002</strong></li></ol><p>然後改用 <em>C#</em> 利用 <code>Microsoft.Office.Interop.Excel</code> 跟 <a href=https://github.com/ExcelDataReader/ExcelDataReader class=external-link target=_blank rel=noopener>ExcelDataReader</a> 解析出來卻是正確的 <strong>0.0004</strong>。</p><p>原以為是 <a href=https://github.com/qax-os/excelize class=external-link target=_blank rel=noopener>excelize</a> 的 bug，於透過解壓縮 <em>*.xlsx</em> 的方式找到 <code>\xl\worksheets\sheet1.xml</code> 發現裡面真的是存 <strong>4.0000000000000002E-4</strong> 😵</p><h2 id=差異原因>差異原因
<a class=heading-link href=#%e5%b7%ae%e7%95%b0%e5%8e%9f%e5%9b%a0><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>基本上這篇 <a href=https://medium.com/starbugs/see-why-floating-point-error-can-not-be-avoided-from-ieee-754-809720b32175 class=external-link target=_blank rel=noopener>從 IEEE 754 標準來看為什麼浮點誤差是無法避免的</a> 已經講得蠻清楚的。另外也可以透過這個 <a href=https://www.binaryconvert.com/convert_double.html class=external-link target=_blank rel=noopener>Double (IEEE754 Double precision 64-bit) Converter</a> 來得到</p><blockquote><p><strong>0.0004</strong> Most accurate representation = <strong>4.00000000000000019168694409544E-4</strong></p></blockquote><p>目前測試的結果看起來 Excel 會依照小數點位數採取不同方式來記錄數字<small>(原因不明)</small></p><ul><li>1 位：直接存</li><li>2 位<small>(不知道為什麼有這兩種差異)</small>：<ul><li>$0.07 = 7.0000000000000007\mathrm{E}{-2}$</li><li>其他則直接用浮點換算的 <code>0.XXXXXXXXXXXXXXXXXX(共18位)</code> 紀錄。</li></ul></li><li>超過 2 位：以科學符號紀錄浮點換算的值，並保留 <strong>17</strong> 個數字，然後第 18 個數字四捨五入。</li></ul><p>所以原本的問題</p><p>$$
0.0004 \approx 4.00000000000000019168694409544\mathrm{E}{-4} \approx 4.0000000000000002\mathrm{E}{-4}
$$</p><h2 id=後記>後記
<a class=heading-link href=#%e5%be%8c%e8%a8%98><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ol><li>參考 <a href=https://coderwall.com/p/app3ya/read-excel-file-in-c class=external-link target=_blank rel=noopener>Read Excel File in C#</a> 使用 <code>Microsoft.Office.Interop.Excel</code> 抓的 <a href=https://docs.microsoft.com/zh-tw/office/vba/api/excel.range.value2 class=external-link target=_blank rel=noopener>Value2</a> 型態是 <code>Double</code> 所以轉換出的結果就是畫面上看到的那樣。</li><li>對於 <a href=https://zh.wikipedia.org/wiki/Office_Open_XML class=external-link target=_blank rel=noopener>Office Open XML</a> 有興趣可以參考這幾篇：<ul><li><a href=https://insutanto.net/code-notes/2021-05/ooxml/what-is-excel-xlsx class=external-link target=_blank rel=noopener>OOXML：Excel(xlsx)是什么</a></li><li><a href=https://insutanto.net/code-notes/2021-05/ooxml/what-is-excel-worksheet class=external-link target=_blank rel=noopener>OOXML：详解 Excel 工作表(worksheet)</a></li><li><a href=https://insutanto.net/code-notes/2021-05/ooxml/what-is-excel-sharedstrings class=external-link target=_blank rel=noopener>OOXML：详解 Excel 共享字符串(sharedStrings)</a></li></ul></li><li><a href=https://www.nuget.org/packages/ExcelDataReader/ class=external-link target=_blank rel=noopener>安裝 ExcelDataReader</a> 記得也 <a href=https://www.nuget.org/packages/ExcelDataReader.DataSet/ class=external-link target=_blank rel=noopener>安裝 ExcelDataReader.DataSet</a> 不然沒法使用範例的 <code>var result = reader.AsDataSet();</code>。</li><li>找到這篇 <a href=https://komotonekobox.blogspot.com/search/label/%28A-c%29Excel%E6%8A%80%E5%B7%A7 class=external-link target=_blank rel=noopener>Excel 技巧整理</a>，雖然現在工作不太接觸 Excel 但還是有備無患。</li><li>也找到微軟官方提供的 <a href=https://docs.microsoft.com/zh-tw/office/troubleshoot/office-client-welcome class=external-link target=_blank rel=noopener>Office 產品疑難排解</a>。</li></ol></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2020 -
2025
法蘭克🤪 + 陳馬尼🐶
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>